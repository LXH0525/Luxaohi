#define _CRT_SECURE_NO_WARNINGS
#include "语法分析器.h"
#include "工具.h"
#include <stdexcept>
#include <sstream>
#include <memory>

语法分析器::语法分析器(const std::vector<词法分析器::令牌>& 令牌列表)
    : 令牌列表(令牌列表), 位置(0) {
}

std::vector<std::shared_ptr<语法树节点>> 语法分析器::分析() {
    std::vector<std::shared_ptr<语法树节点>> 节点列表;
    while (!匹配(词法分析器::结束)) {
        if (匹配(词法分析器::分号)) { 消耗(); continue; }
        if (匹配(词法分析器::函数关键字)) 节点列表.push_back(分析函数());
        else if (匹配(词法分析器::如果关键字)) 节点列表.push_back(分析如果语句());
        else if (匹配(词法分析器::变量关键字)) 节点列表.push_back(分析变量赋值());
        else if (检查标识符后有左括号()) 节点列表.push_back(分析调用());
        else 消耗();
    }
    return 节点列表;
}

bool 语法分析器::匹配(词法分析器::令牌类型 类型) {
    return 位置 < 令牌列表.size() && 令牌列表[位置].类型 == 类型;
}

bool 语法分析器::检查标识符后有左括号() {
    size_t 检查位置 = 位置;
    while (检查位置 < 令牌列表.size() && 令牌列表[检查位置].类型 == 词法分析器::分号) 检查位置++;
    return 检查位置 + 1 < 令牌列表.size() &&
        令牌列表[检查位置].类型 == 词法分析器::标识符 &&
        令牌列表[检查位置 + 1].类型 == 词法分析器::左括号;
}

词法分析器::令牌 语法分析器::消耗(词法分析器::令牌类型 类型, const std::string& 错误信息) {
    while (位置 < 令牌列表.size() && 令牌列表[位置].类型 == 词法分析器::分号) 位置++;
    if (匹配(类型)) return 令牌列表[位置++];
    throw std::runtime_error(错误信息);
}

词法分析器::令牌 语法分析器::消耗() {
    if (位置 < 令牌列表.size()) return 令牌列表[位置++];
    return 词法分析器::令牌(词法分析器::结束, "", 0, 0);
}

std::shared_ptr<函数声明节点> 语法分析器::分析函数() {
    auto 函数节点 = std::make_shared<函数声明节点>();
    消耗(词法分析器::函数关键字, "刘小黑[预期函数关键字'喵'呢~]");
    函数节点->名称 = 消耗(词法分析器::标识符, "刘小黑[想要一个函数名可以嘛~]").值;
    消耗(词法分析器::左括号, "刘小黑[预期'('呢]");
    while (!匹配(词法分析器::右括号)) {
        函数节点->参数列表.push_back(消耗(词法分析器::标识符, "刘小黑[预期一个参数名...]").值);
        if (!匹配(词法分析器::右括号)) 消耗(词法分析器::逗号, "刘小黑[预期','用来分隔参数喵~]");
    }
    消耗(词法分析器::右括号, "刘小黑[预期')'呢]");
    消耗(词法分析器::左花括号, "刘小黑[预期'{'开始函数体呢]");
    while (!匹配(词法分析器::右花括号)) {
        if (匹配(词法分析器::如果关键字)) 函数节点->函数体.push_back(分析如果语句());
        else if (匹配(词法分析器::变量关键字)) 函数节点->函数体.push_back(分析变量赋值());
        else if (检查标识符后有左括号()) 函数节点->函数体.push_back(分析调用());
        else if (匹配(词法分析器::分号)) 消耗();
        else 消耗();
    }
    消耗(词法分析器::右花括号, "刘小黑[预期'}'结束函数体...]");
    return 函数节点;
}

std::shared_ptr<函数调用节点> 语法分析器::分析调用() {
    auto 调用节点 = std::make_shared<函数调用节点>();
    调用节点->名称 = 消耗(词法分析器::标识符, "刘小黑[想要一个函数名可以嘛~]").值;
    消耗(词法分析器::左括号, "刘小黑[预期'('呢]");
    while (!匹配(词法分析器::右括号)) {
        std::stringstream 参数表达式流;
        while (!匹配(词法分析器::右括号) && !匹配(词法分析器::逗号) && !匹配(词法分析器::结束)) {
            auto 令牌 = 消耗(); 参数表达式流 << 令牌.值;
        }
        std::string 参数 = 参数表达式流.str();
        if (!参数.empty()) 调用节点->实参列表.push_back(参数);
        if (匹配(词法分析器::逗号)) 消耗(词法分析器::逗号, "刘小黑[预期','用来分隔参数喵~]");
    }
    消耗(词法分析器::右括号, "刘小黑[预期')'呢]");
    return 调用节点;
}

std::shared_ptr<变量赋值节点> 语法分析器::分析变量赋值() {
    auto 赋值节点 = std::make_shared<变量赋值节点>();
    消耗(词法分析器::变量关键字, "刘小黑[预期'变量'关键字喵~]");
    赋值节点->变量名 = 消耗(词法分析器::标识符, "刘小黑[预期一个变量名~]").值;
    消耗(词法分析器::等号, "刘小黑[预期'='呢]");
    std::stringstream 表达式流;
    while (!匹配(词法分析器::分号) && !匹配(词法分析器::结束) &&
        !匹配(词法分析器::变量关键字) && !匹配(词法分析器::如果关键字) &&
        !匹配(词法分析器::函数关键字) && !检查标识符后有左括号()) {
        auto 令牌 = 消耗(); 表达式流 << 令牌.值;
    }
    赋值节点->值 = 表达式流.str();
    if (匹配(词法分析器::分号)) 消耗(词法分析器::分号, "刘小黑[预期';'喵]");
    return 赋值节点;
}

std::shared_ptr<条件语句节点> 语法分析器::分析如果语句() {
    auto 如果节点 = std::make_shared<条件语句节点>();
    消耗(词法分析器::如果关键字, "刘小黑[预期'如果'...]");
    std::stringstream 条件流;
    while (!匹配(词法分析器::那么关键字) && !匹配(词法分析器::结束)) {
        auto 令牌 = 消耗(); 条件流 << 令牌.值;
    }
    如果节点->条件 = 条件流.str();
    消耗(词法分析器::那么关键字, "刘小黑[预期'那么'分支...]");
    消耗(词法分析器::左花括号, "刘小黑[" + 全局用户名 + "，那么后面需要加上一个'{'来开始代码块喵~]");
    while (!匹配(词法分析器::右花括号)) {
        if (匹配(词法分析器::如果关键字)) 如果节点->那么分支.push_back(分析如果语句());
        else if (匹配(词法分析器::变量关键字)) 如果节点->那么分支.push_back(分析变量赋值());
        else if (检查标识符后有左括号()) 如果节点->那么分支.push_back(分析调用());
        else if (匹配(词法分析器::分号)) 消耗();
        else 消耗();
    }
    消耗(词法分析器::右花括号, "刘小黑[" + 全局用户名 + "，那么结束的时候需要加上一个'}'来结束代码块喵~]");
    if (匹配(词法分析器::否则关键字)) {
        消耗(词法分析器::否则关键字, "[哈哈哈，我是占位]");
        if (匹配(词法分析器::如果关键字)) {
            如果节点->否则分支.push_back(分析如果语句());
        }
        else {
            消耗(词法分析器::左花括号, "刘小黑[" + 全局用户名 + "，否则后面需要加上一个'{'来开始代码块哦]");
            while (!匹配(词法分析器::右花括号)) {
                if (匹配(词法分析器::如果关键字)) 如果节点->否则分支.push_back(分析如果语句());
                else if (匹配(词法分析器::变量关键字)) 如果节点->否则分支.push_back(分析变量赋值());
                else if (检查标识符后有左括号()) 如果节点->否则分支.push_back(分析调用());
                else if (匹配(词法分析器::分号)) 消耗();
                else 消耗();
            }
            消耗(词法分析器::右花括号, "刘小黑[" + 全局用户名 + "，否则分支缺少结束用的'}'喵~]");
        }
    }
    return 如果节点;
}